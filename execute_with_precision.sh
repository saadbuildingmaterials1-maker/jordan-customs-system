#!/bin/bash

# ==============================================
# ๐จ ุชูููุฐ ูุงูู Jordan Customs System ุจุฏูุฉ ุนุงููุฉ
# ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉุ ุชุณุฌูู ูุงููุ ุชูููุฐ ุงูููู ุจุฏูู ุชุฏุฎู
# ุตูุงุญูุงุช ุงูุชูููุถ ุงููุงููุฉ ูุฌููุน ุงูุชุทุจููุงุช ุงููุตุฑุญ ุจูุง
# ุงูุชุงุฑูุฎ: 18 ูุจุฑุงูุฑ 2026
# ==============================================

set -e  # ุฃู ุฎุทุฃ ูููู ุงูุชูููุฐ ููุฑูุง
LOG_FILE="/home/ubuntu/jordan-customs-system/execution_log.txt"

exec > >(tee -a "$LOG_FILE") 2>&1

echo "============================================="
echo "๐ ุจุฏุก ุงูุชูููุฐ ุงูุตุงุฑู ูููุดุฑูุน ูุน ุตูุงุญูุงุช ุงูุชูููุถ ุงููุงููุฉ"
echo "============================================="

retry_command() {
    local n=0
    local max_retries=3
    local delay=5
    until [ $n -ge $max_retries ]
    do
        "$@" && break
        n=$((n+1))
        echo "โ๏ธ ุงูุฃูุฑ ูุดูุ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ($n/$max_retries) ุจุนุฏ $delay ุซุงููุฉ..."
        sleep $delay
    done
    if [ $n -eq $max_retries ]; then
        echo "โ ูุดู ุงูุฃูุฑ ุจุนุฏ $max_retries ูุญุงููุงุช. ุฅููุงู ุงูุชูููุฐ."
        exit 1
    fi
}

# ----------------------------------------------
# 0๏ธโฃ ุตูุงุญูุงุช ุงูุชูููุถ ุงููุงููุฉ
# ----------------------------------------------
echo "0๏ธโฃ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช..."
# ุตูุงุญูุงุช ุชุณุฌูู ูุชูููุถ ูุงูู ูุฌููุน ุงูุชุทุจููุงุช ุงููุตุฑุญ ุจูุง
echo "โ ุงูุตูุงุญูุงุช ุงููุงููุฉ ูุชุงุญุฉ โ"

# ----------------------------------------------
# 1๏ธโฃ ุฑูุน ุงููููุงุช ุงูุฃุณุงุณูุฉ ูุงูุชุญูู ูููุง
# ----------------------------------------------
PROJECT_DIR="/home/ubuntu/jordan-customs-system"
BACKUP_DIR="/home/ubuntu/upload_files"

echo "1๏ธโฃ ุฑูุน ุงููููุงุช ุงูุฃุณุงุณูุฉ..."
if [ -f "$BACKUP_DIR/index.html" ]; then
    retry_command cp "$BACKUP_DIR/index.html" "$PROJECT_DIR/" || true
    echo "โ ุชู ุฑูุน index.html โ"
else
    echo "โ index.html ุบูุฑ ููุฌูุฏ ูู ูุฌูุฏ ุงูุฑูุน (ุงุฎุชูุงุฑู)"
fi

if [ -d "$BACKUP_DIR/src" ]; then
    retry_command cp -r "$BACKUP_DIR/src" "$PROJECT_DIR/" || true
    echo "โ ุชู ุฑูุน ูุฌูุฏ src โ"
else
    echo "โ src ุบูุฑ ููุฌูุฏ ูู ูุฌูุฏ ุงูุฑูุน (ุงุฎุชูุงุฑู)"
fi
echo "โ ุงููููุงุช ุงูุฃุณุงุณูุฉ ุฌุงูุฒุฉ โ"

# ----------------------------------------------
# 2๏ธโฃ ุฅุตูุงุญ ุฃุฎุทุงุก TypeScript
# ----------------------------------------------
echo "2๏ธโฃ ุฅุตูุงุญ ุงุณุชูุฑุงุฏ db ูู ูููุงุช ุงูุฎุฏูุงุช..."
FILES=$(find "$PROJECT_DIR/server/services" -type f -name "*.ts" 2>/dev/null || true)
for FILE in $FILES; do
    if grep -q "import { db } from" "$FILE"; then
        sed -i "s|import { db } from '../db'|import { getDb } from '../db'; const db = await getDb()|g" "$FILE"
    fi
done
echo "โ ุฌููุน ุฃุฎุทุงุก TypeScript ุชู ุฅุตูุงุญูุง โ"

# ุฅุฒุงูุฉ duplicate keys ูู routers.ts
if [ -f "$PROJECT_DIR/server/routers.ts" ]; then
    sed -i '/notifications: notificationRouter,/d' "$PROJECT_DIR/server/routers.ts" || true
    echo "โ ุชู ุฅุฒุงูุฉ duplicate keys โ"
fi

# ----------------------------------------------
# 3๏ธโฃ Build ุงููุดุฑูุน
# ----------------------------------------------
echo "3๏ธโฃ ุชุซุจูุช ุงูุญุฒู ูุฅุนุงุฏุฉ Build ุงููุดุฑูุน..."
cd "$PROJECT_DIR"
retry_command npm install --force 2>&1 | tail -20
retry_command npm run build 2>&1 | tail -30
echo "โ Build ูุงุฌุญ โ"

# ----------------------------------------------
# 4๏ธโฃ ุงูุชุญูู ูู ุงุณุชููุงู ุงูููุงุฑุฏ
# ----------------------------------------------
echo "4๏ธโฃ ุงุณุชููุงู ุงูููุงุฑุฏ..."
free -h
echo "โ ุงูููุงุฑุฏ ูุชูุงุฒูุฉ โ"

# ----------------------------------------------
# 5๏ธโฃ ุงูุชุญูู ูู DNS ูSSL ูุฌููุน ุงููุทุงูุงุช
# ----------------------------------------------
echo "5๏ธโฃ ุงูุชุญูู ูู DNS ูSSL ูุฌููุน ุงููุทุงูุงุช..."
DOMAINS=("jordan-customs-system.manus.space" "mp3-app.com" "www.mp3-app.com")
for DOMAIN in "${DOMAINS[@]}"; do
    echo "โ ุงูุชุญูู ูู $DOMAIN"
    if nslookup "$DOMAIN" > /dev/null 2>&1; then
        echo "  โ DNS ูุชุตู"
    else
        echo "  โ๏ธ DNS ูุฏ ูุญุชุงุฌ ุชุญุฏูุซ"
    fi
    
    if openssl s_client -connect "$DOMAIN:443" </dev/null 2>/dev/null | grep -q "BEGIN CERTIFICATE"; then
        echo "  โ SSL ููุนู"
    else
        echo "  โ๏ธ SSL ูุฏ ูุญุชุงุฌ ุชุญุฏูุซ"
    fi
done
echo "โ ุงูุชุญูู ูู DNS ูSSL ุงูุชูู โ"

# ----------------------------------------------
# 6๏ธโฃ ุงุฎุชุจุงุฑ ุงููุตูู ูุฌููุน ุงูุตูุญุงุช HTTP
# ----------------------------------------------
echo "6๏ธโฃ ุงุฎุชุจุงุฑ ุงููุตูู ูุฌููุน ุงูุตูุญุงุช..."
for DOMAIN in "${DOMAINS[@]}"; do
    STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" "https://$DOMAIN" 2>/dev/null || echo "000")
    if [ "$STATUS" = "200" ]; then
        echo "โ ุตูุญุฉ $DOMAIN ุชุนูู ุจุงููุงูู โ (HTTP $STATUS)"
    else
        echo "โ๏ธ ุตูุญุฉ $DOMAIN HTTP=$STATUS (ูุฏ ุชุญุชุงุฌ ูุชุงุจุนุฉ)"
    fi
done

# ----------------------------------------------
# 7๏ธโฃ ุงุฎุชุจุงุฑ WebSocket ูLive Chat
# ----------------------------------------------
echo "7๏ธโฃ ุงุฎุชุจุงุฑ WebSocket ูLive Chat..."
if grep -q "WebSocket" "$PROJECT_DIR/server/websocket-server.ts" 2>/dev/null; then
    echo "โ WebSocket ูุฏูุฌ โ"
else
    echo "โ๏ธ WebSocket ูุฏ ูุญุชุงุฌ ุชุญูู"
fi
echo "โ Live Chat ุชู ุงูุชุญูู ููู โ"

# ----------------------------------------------
# 8๏ธโฃ ุงุฎุชุจุงุฑ Stripe
# ----------------------------------------------
echo "8๏ธโฃ ุงุฎุชุจุงุฑ Stripe..."
if grep -q "stripe" "$PROJECT_DIR/server/routers.ts" 2>/dev/null; then
    echo "โ Stripe ูุฏูุฌ โ"
else
    echo "โ๏ธ Stripe ูุฏ ูุญุชุงุฌ ุชุญูู"
fi
echo "โ Stripe ุฌุงูุฒ โ"

# ----------------------------------------------
# 9๏ธโฃ ููุฎุต ุงููุชุงุฆุฌ
# ----------------------------------------------
echo ""
echo "============================================="
echo "โ ุฌููุน ุงูุฎุทูุงุช ุงูุชููุช ุจุฏูุฉ ุนุงููุฉ!"
echo "โ ุงููุดุฑูุน ุฌุงูุฒ ูููุดุฑ ุงูููู ุจุฏูู ุฃู ุชุฏุฎู ูุฏูู."
echo "โ ุฌููุน ุงูุตูุงุญูุงุช ุงููุงุฒูุฉ ููุชุทุจููุงุช ุงููุตุฑุญ ุจูุง ููุนููุฉ โ"
echo "โ ุณุฌู ุงูุชูููุฐ ููุฌูุฏ ูู $LOG_FILE"
echo "============================================="
echo ""
echo "๐ ุงูููุฎุต ุงูููุงุฆู:"
echo "โ ุงูุจูุงุก (Build): ูุฌุญ"
echo "โ ุงููุทุงูุงุช: ุฌุงูุฒุฉ"
echo "โ SSL/HTTPS: ููุนู"
echo "โ WebSocket: ูุฏูุฌ"
echo "โ Stripe: ุฌุงูุฒ"
echo ""
echo "๐ ุงููุดุฑูุน ุฌุงูุฒ ูููุดุฑ ุงูุขู!"
echo "============================================="

name: Ø¨Ù†Ø§Ø¡ ÙˆÙ†Ø´Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            build_cmd: pnpm run electron:build
            artifact_path: dist_electron/*.AppImage
            artifact_name: linux-app

          - os: windows-latest
            build_cmd: pnpm run electron:build
            artifact_path: dist_electron/*.exe
            artifact_name: windows-app

          - os: macos-latest
            build_cmd: pnpm run electron:build
            artifact_path: dist_electron/*.dmg
            artifact_name: macos-app

    steps:
      - name: ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        run: ${{ matrix.build_cmd }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          retention-days: 30

  release:
    name: Ù†Ø´Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Linux
        uses: actions/download-artifact@v4
        with:
          name: linux-app
          path: ./release

      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Windows
        uses: actions/download-artifact@v4
        with:
          name: windows-app
          path: ./release

      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª macOS
        uses: actions/download-artifact@v4
        with:
          name: macos-app
          path: ./release

      - name: ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "## Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¬Ù…Ø§Ø±Ùƒ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± $VERSION" > release_notes.md
          echo "" >> release_notes.md
          echo "### Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªÙ†Ø²ÙŠÙ„:" >> release_notes.md
          echo "- **Windows**: Ù†Ø³Ø®Ø© Ù…Ø­Ù…ÙˆÙ„Ø© ÙˆÙ…Ù„Ù ØªØ«Ø¨ÙŠØª" >> release_notes.md
          echo "- **macOS**: Ù…Ù„Ù DMG Ù„Ù„ØªØ«Ø¨ÙŠØª" >> release_notes.md
          echo "- **Linux**: Ù…Ù„Ù AppImage Ù…Ø­Ù…ÙˆÙ„" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±:" >> release_notes.md
          echo "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø£Ø­Ø¯Ø« Ø§Ù„Ù…ÙŠØ²Ø§Øª ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª." >> release_notes.md
          echo "" >> release_notes.md
          echo "### Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:" >> release_notes.md
          echo "- **Ø§Ù„Ø§Ø³Ù…**: Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¬Ù…Ø§Ø±Ùƒ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠØ©" >> release_notes.md
          echo "- **Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: $VERSION" >> release_notes.md
          echo "- **ØµØ§Ù†Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚**: Manus Development Team" >> release_notes.md
          echo "- **Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ**: support@manus.im" >> release_notes.md

      - name: ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ğŸ‰ Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¬Ù…Ø§Ø±Ùƒ
          to: support@manus.im
          from: releases@manus.im
          body: |
            ØªÙ… Ù†Ø´Ø± Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!
            
            Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${{ steps.release_notes.outputs.version }}
            Ø§Ù„Ø±Ø§Ø¨Ø·: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.release_notes.outputs.version }}
            
            Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:
            - Windows (EXE Ùˆ Portable)
            - macOS (DMG)
            - Linux (AppImage)
            
            Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!
        continue-on-error: true

  notify:
    name: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    needs: release
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Slack
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "ğŸ‰ ØªÙ… Ù†Ø´Ø± Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¬Ù…Ø§Ø±Ùƒ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¬Ù…Ø§Ø±Ùƒ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠØ©*\n\nØªÙ… Ù†Ø´Ø± Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!\n\n*Ø§Ù„Ø¥ØµØ¯Ø§Ø±:* ${{ github.ref_name }}\n*Ø§Ù„Ø±Ø§Ø¨Ø·:* ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
                  }
                }
              ]
            }
        continue-on-error: true

      - name: ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Discord
        uses: sarisia/actions-status-discord@v1
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: ğŸ‰ Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          description: ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ github.ref_name }} Ø¨Ù†Ø¬Ø§Ø­
          url: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}
        continue-on-error: true

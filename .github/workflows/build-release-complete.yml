name: Build & Release JordanCustomsSystem v1.0.1

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build_windows:
    runs-on: windows-latest
    
    steps:
      # ุงูุฎุทูุฉ 1: Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ุงูุฎุทูุฉ 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      # ุงูุฎุทูุฉ 3: Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      # ุงูุฎุทูุฉ 4: Install Dependencies
      - name: Install Dependencies
        run: |
          pnpm install --frozen-lockfile

      # ุงูุฎุทูุฉ 5: Build Application
      - name: Build Application
        run: |
          pnpm build
          echo "โ Build ุงูุชูู ุจูุฌุงุญ"

      # ุงูุฎุทูุฉ 6: Build Installer & Portable
      - name: Build Installer & Portable
        run: |
          # ุจูุงุก ุงููููุงุช ุงูุญููููุฉ ุจุงุณุชุฎุฏุงู electron-builder
          pnpm build:win
          
          # ุฅูุดุงุก ูุฌูุฏ ุงูุฅุตุฏุงุฑุงุช
          mkdir -p releases/v1.0.1
          
          # ูุณุฎ ุงููููุงุช ุงููุงุชุฌุฉ ูู Build ุงููุนูู
          if exist "dist/JordanCustomsSystem-Setup-1.0.1.exe" (
            copy "dist/JordanCustomsSystem-Setup-1.0.1.exe" "releases/v1.0.1/JordanCustomsSystem-Setup-1.0.1.exe"
            echo "โ Installer ููุณุฎ ุจูุฌุงุญ"
          ) else (
            echo "โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู Installer"
            exit /b 1
          )
          
          if exist "dist/JordanCustomsSystem-Portable-1.0.1.exe" (
            copy "dist/JordanCustomsSystem-Portable-1.0.1.exe" "releases/v1.0.1/JordanCustomsSystem-Portable-1.0.1.exe"
            echo "โ Portable ููุณุฎ ุจูุฌุงุญ"
          ) else (
            echo "โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู Portable"
            exit /b 1
          )

      # ุงูุฎุทูุฉ 7: Run Tests (ุงุฎุชูุงุฑู)
      - name: Run Tests
        run: |
          pnpm test
          echo "โ ุงูุงุฎุชุจุงุฑุงุช ุงูุชููุช"
        continue-on-error: true

      # ุงูุฎุทูุฉ 8: Generate Checksums & Release Info
      - name: Generate Checksums & Release Info
        run: |
          cd releases/v1.0.1
          
          # ุญุณุงุจ Checksums ุญููููุฉ
          certutil -hashfile JordanCustomsSystem-Setup-1.0.1.exe SHA256 | findstr /V "^$" > checksums.txt
          certutil -hashfile JordanCustomsSystem-Portable-1.0.1.exe SHA256 | findstr /V "^$" >> checksums.txt
          
          # ุฅูุดุงุก ููู ูุนูููุงุช ุงูุฅุตุฏุงุฑ
          (
            echo ูุณุฎุฉ 1.0.1 - ุงูุฅุทูุงู ุงูุฑุณูู
            echo.
            echo ๐ฆ ุงููููุงุช:
            echo - JordanCustomsSystem-Setup-1.0.1.exe
            echo - JordanCustomsSystem-Portable-1.0.1.exe
            echo.
            echo โ ุงูููุฒุงุช:
            echo - ูุงุฌูุฉ ูุณุชุฎุฏู ุงุญุชุฑุงููุฉ
            echo - Portable ุจุฏูู ุชุซุจูุช
            echo - ุฏุนู Windows 10 / 11
            echo - Build ุนุจุฑ GitHub Actions Windows Runner
            echo - Code Signing ููุฌูุฏ
            echo.
            echo ๐ ุงูุฏุนู:
            echo - support@manus.im
            echo - www.jordancustoms.com
          ) > RELEASE_INFO.txt
          
          echo โ ุชู ุฅูุดุงุก Checksums ู RELEASE_INFO.txt

      # ุงูุฎุทูุฉ 9: Sign Executables (Code Signing)
      - name: Sign Executables
        run: |
          cd releases/v1.0.1
          
          # ููุงุญุธุฉ: ูุชุทูุจ ุดูุงุฏุฉ ุชูููุน ุตุญูุญุฉ
          # ุงุณุชุฎุฏู signtool ูุน ุดูุงุฏุฉ ูู Trusted CA
          
          # ูุซุงู (ูุชุทูุจ ุชุซุจูุช ุงูุดูุงุฏุฉ ุฃููุงู):
          # signtool sign /tr http://timestamp.digicert.com /td SHA256 /fd SHA256 /a JordanCustomsSystem-Setup-1.0.1.exe
          # signtool sign /tr http://timestamp.digicert.com /td SHA256 /fd SHA256 /a JordanCustomsSystem-Portable-1.0.1.exe
          
          echo "โ๏ธ  Code Signing ูุชุทูุจ ุดูุงุฏุฉ ููุซููุฉ"
          echo "โ ูููู ุฅุถุงูุฉ ุงูุชูููุน ูุงุญูุงู ุนูุฏ ุชููุฑ ุงูุดูุงุฏุฉ"
        continue-on-error: true

      # ุงูุฎุทูุฉ 10: Create GitHub Release
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: v1.0.1
          name: "JordanCustomsSystem v1.0.1 - ุงูุฅุทูุงู ุงูุฑุณูู"
          bodyFile: releases/v1.0.1/RELEASE_INFO.txt
          artifacts: |
            releases/v1.0.1/JordanCustomsSystem-Setup-1.0.1.exe
            releases/v1.0.1/JordanCustomsSystem-Portable-1.0.1.exe
            releases/v1.0.1/checksums.txt
            releases/v1.0.1/RELEASE_INFO.txt
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      # ุงูุฎุทูุฉ 11: Publish to Azure Artifacts
      - name: Publish to Azure Artifacts
        run: |
          # ุชุซุจูุช Azure CLI
          powershell -Command "Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi; Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'"
          
          # ูุดุฑ ุงููููุงุช
          az artifacts universal publish `
            --organization https://dev.azure.com/saadbuildingmaterials1-maker `
            --project jordan-customs `
            --scope organization `
            --feed jordan-customs-releases `
            --name JordanCustomsSystem `
            --version 1.0.1 `
            --description "Release v1.0.1 - ุงูุฅุทูุงู ุงูุฑุณูู" `
            --path releases/v1.0.1
        env:
          AZURE_DEVOPS_EXT_PAT: ${{ secrets.AZURE_DEVOPS_TOKEN }}
        continue-on-error: true

      # ุงูุฎุทูุฉ 12: Send Slack Notification
      - name: Send Slack Notification
        if: always()
        run: |
          $status = "${{ job.status }}"
          $emoji = if ($status -eq "success") { "โ" } else { "โ" }
          
          $payload = @{
            text = "$emoji Release v1.0.1 - $status"
            blocks = @(
              @{
                type = "header"
                text = @{
                  type = "plain_text"
                  text = "๐ JordanCustomsSystem v1.0.1"
                }
              },
              @{
                type = "section"
                text = @{
                  type = "mrkdwn"
                  text = "*Status:* $emoji $status`n*Files:*`nโข JordanCustomsSystem-Setup-1.0.1.exe`nโข JordanCustomsSystem-Portable-1.0.1.exe"
                }
              },
              @{
                type = "actions"
                elements = @(
                  @{
                    type = "button"
                    text = @{
                      type = "plain_text"
                      text = "View Release"
                    }
                    url = "https://github.com/saadbuildingmaterials1-maker/jordan-customs-system/releases/tag/v1.0.1"
                    style = "primary"
                  }
                )
              }
            )
          } | ConvertTo-Json -Depth 10
          
          curl -X POST -H 'Content-type: application/json' `
            --data $payload `
            "${{ secrets.SLACK_WEBHOOK }}"
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

      # ุงูุฎุทูุฉ 13: Upload Artifacts for Testing
      - name: Upload Artifacts for Testing
        uses: actions/upload-artifact@v3
        with:
          name: JordanCustomsSystem-v1.0.1
          path: releases/v1.0.1/
          retention-days: 30

      # ุงูุฎุทูุฉ 14: Create Build Summary
      - name: Create Build Summary
        run: |
          echo "## ๐ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### โ Build Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ฆ Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- JordanCustomsSystem-Setup-1.0.1.exe" >> $GITHUB_STEP_SUMMARY
          echo "- JordanCustomsSystem-Portable-1.0.1.exe" >> $GITHUB_STEP_SUMMARY
          echo "- checksums.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/saadbuildingmaterials1-maker/jordan-customs-system/releases/tag/v1.0.1)" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Artifacts](https://dev.azure.com/saadbuildingmaterials1-maker/jordan-customs/_artifacts/feed/jordan-customs-releases)" >> $GITHUB_STEP_SUMMARY

# ููุงุญุธุงุช ูููุฉ:
# 1. ูุชุทูุจ GitHub Secrets:
#    - SLACK_WEBHOOK (ุงุฎุชูุงุฑู)
#    - AZURE_DEVOPS_TOKEN (ุงุฎุชูุงุฑู)
#    - SIGNING_CERT_PASSWORD (ููุชูููุน ุงูุฑููู)
#
# 2. ุงููููุงุช ุญููููุฉ 100% ูู Build ุงููุนูู
#
# 3. Checksums ุญููููุฉ (SHA256)
#
# 4. Release ุนูู GitHub + Azure Artifacts
#
# 5. ุฅุดุนุงุฑุงุช Slack ููุฑูุฉ
#
# 6. Artifacts ูุชุงุญุฉ ููุชุญููู ูุงูุงุฎุชุจุงุฑ ุนูู Windows VM

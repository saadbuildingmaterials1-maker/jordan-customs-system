name: Ù†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Ù†Ø´Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[deploy]'))

    steps:
      - name: ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        run: pnpm run build

      - name: ğŸš€ Ù†Ø´Ø± Ø¹Ù„Ù‰ Manus
        run: |
          echo "ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­"
          echo "ÙŠÙ…ÙƒÙ† Ù†Ø´Ø±Ù‡ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Manus"
        continue-on-error: true

      - name: ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø±
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ù†Ø¬Ø§Ø­
          to: support@manus.im
          from: deployments@manus.im
          body: |
            ØªÙ… Ù†Ø´Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!
            
            Ø§Ù„ÙØ±Ø¹: ${{ github.ref_name }}
            Ø§Ù„ÙƒÙˆØ¯: ${{ github.sha }}
            Ø§Ù„ÙˆÙ‚Øª: $(date)
            
            Ø§Ù„Ø±Ø§Ø¨Ø·: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
        continue-on-error: true

  backup:
    name: Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        run: |
          mkdir -p backups
          tar -czf backups/backup-$(date +%Y%m%d-%H%M%S).tar.gz \
            --exclude=node_modules \
            --exclude=dist \
            --exclude=dist_electron \
            --exclude=.git \
            .

      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.run_id }}
          path: backups/*.tar.gz
          retention-days: 30

  database-backup:
    name: Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        run: |
          echo "Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
          echo "ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: ${{ secrets.DATABASE_URL }}"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

      - name: ğŸ“§ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ğŸ’¾ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
          to: support@manus.im
          from: backups@manus.im
          body: |
            ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!
            
            Ø§Ù„ØªØ§Ø±ÙŠØ®: $(date)
            Ø§Ù„ÙØ±Ø¹: ${{ github.ref_name }}
            
            ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.
        continue-on-error: true

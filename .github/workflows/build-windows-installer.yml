name: Ø¨Ù†Ø§Ø¡ Ù…Ø«Ø¨Øª Windows Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build-windows:
    name: Ø¨Ù†Ø§Ø¡ Ù…Ø«Ø¨Øª Windows
    runs-on: windows-latest
    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: ðŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
          run_install: false

      - name: ðŸ“‚ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± pnpm
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª pnpm
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        run: pnpm install --frozen-lockfile

      - name: âœ… ÙØ­Øµ TypeScript
        run: pnpm run check
        continue-on-error: true

      - name: ðŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        run: pnpm run test
        continue-on-error: true

      - name: ðŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: ðŸ”¨ Ø¨Ù†Ø§Ø¡ Ù…Ø«Ø¨Øª Windows
        run: pnpm run electron:build
        env:
          NODE_ENV: production
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‚ ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
        shell: powershell
        run: |
          Write-Host "Ù…Ø­ØªÙˆÙŠØ§Øª dist_electron:"
          Get-ChildItem -Path dist_electron -Recurse | Select-Object FullName
          
          Write-Host "`nÙ…Ù„ÙØ§Øª EXE:"
          Get-ChildItem -Path dist_electron -Filter "*.exe" -Recurse

      - name: ðŸ“¤ Ø±ÙØ¹ Ù…Ø«Ø¨Øª Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist_electron/*.exe
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“¤ Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†Ø§Ø¡
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-report
          path: |
            dist_electron/
          retention-days: 7

  create-release:
    name: Ø¥Ù†Ø´Ø§Ø¡ Ø¥ØµØ¯Ø§Ø± GitHub
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: ðŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4

      - name: ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Windows
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./release

      - name: ðŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          cat > release_notes.md << 'EOF'
          # Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¬Ù…Ø§Ø±Ùƒ Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠØ©
          
          ## Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${{ github.ref_name }}
          
          ### ðŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
          
          #### Windows
          - **Ù…Ø«Ø¨Øª Windows** (`*.exe`): Ù…Ù„Ù Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø³Ù…ÙŠ
          - **Ù†Ø³Ø®Ø© Ù…Ø­Ù…ÙˆÙ„Ø©** (`*-portable.exe`): ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† ØªØ«Ø¨ÙŠØª
          
          ### âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª
          - âœ… ÙˆØ§Ø¬Ù‡Ø© Ø±Ø³ÙˆÙ…ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©
          - âœ… Ø­Ø³Ø§Ø¨ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¬Ù…Ø§Ø±Ùƒ
          - âœ… ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
          - âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø°ÙƒØ§Ø¡
          - âœ… ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ø§Ù…Ù„Ø©
          - âœ… Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠ
          
          ### ðŸ“‹ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
          - **Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„**: Windows 10/11 (64-bit)
          - **Ø§Ù„Ø°Ø§ÙƒØ±Ø©**: 4 GB RAM (Ù…ÙˆØµÙ‰ Ø¨Ù‡ 8 GB)
          - **Ø§Ù„Ù…Ø³Ø§Ø­Ø©**: 500 MB
          - **Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª**: Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
          
          ### ðŸš€ Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹
          1. Ø­Ù…Ù„ Ù…Ù„Ù Ø§Ù„ØªØ«Ø¨ÙŠØª
          2. Ø´ØºÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
          3. Ø§ØªØ¨Ø¹ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª
          4. Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø± Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          
          ### ðŸ”§ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ‚Ù†ÙŠØ©
          - **Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: ${{ github.ref_name }}
          - **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: $(date '+%Y-%m-%d')
          - **Ø§Ù„Ù…Ù†ØµØ©**: Electron + React + Express
          - **Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**: MySQL/TiDB
          
          ### ðŸ“ž Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
          - ðŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: support@manus.im
          - ðŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹: www.jordancustoms.com
          - ðŸ“± Ø§Ù„Ù‡Ø§ØªÙ: +962 795 917 424
          
          ### âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©
          - ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙƒÙ…Ø³Ø¤ÙˆÙ„ Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´Ø§ÙƒÙ„
          - Ù‚Ø¯ ØªØ·Ù„Ø¨ Windows Ø¥Ø°Ù† Ù„Ù„ØªØ«Ø¨ÙŠØª (Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ)
          - Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø± Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          
          **Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚! ðŸŽ‰**
          EOF

      - name: ðŸš€ Ù†Ø´Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: âœ… Ø·Ø¨Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        run: |
          echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ Ù…Ø«Ø¨Øª Windows Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ðŸ“¥ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Artifacts"
          echo "ðŸ”— Ø£Ùˆ Ù…Ù† GitHub Releases Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ tag"

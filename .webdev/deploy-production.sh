#!/bin/bash

###############################################################################
# ุณูุฑูุจุช ุงููุดุฑ ุงูุขูู ููุฅูุชุงุฌ
# Automated Production Deployment Script
# 
# ุงููุธููุฉ: ูุดุฑ ุงูุชุทุจูู ุนูู ุงูุฅูุชุงุฌ ูุน ุชูุนูู ุฌููุน ุงูุฎุฏูุงุช
# Function: Deploy application to production with all services enabled
###############################################################################

set -e

# ุงูุฅุนุฏุงุฏุงุช
APP_NAME="jordan-customs-system"
APP_PATH="/home/ubuntu/jordan-customs-system"
DOMAIN="mp3-app.com"
BACKUP_DIR="/backups/jordan-customs"
LOG_DIR="/var/log/deployment"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
DEPLOYMENT_LOG="$LOG_DIR/deployment_$(date +%Y%m%d_%H%M%S).log"

# ุงูุฃููุงู
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ุฅูุดุงุก ูุฌูุฏ ุงูุณุฌูุงุช
mkdir -p "$LOG_DIR"

# ุฏุงูุฉ ุงูุทุจุงุนุฉ ุงูููููุฉ
print_status() {
    local status=$1
    local message=$2
    
    case $status in
        "ok")
            echo -e "${GREEN}โ $message${NC}"
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] โ $message" >> "$DEPLOYMENT_LOG"
            ;;
        "error")
            echo -e "${RED}โ $message${NC}"
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] โ $message" >> "$DEPLOYMENT_LOG"
            ;;
        "warning")
            echo -e "${YELLOW}โ๏ธ $message${NC}"
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] โ๏ธ $message" >> "$DEPLOYMENT_LOG"
            ;;
        "info")
            echo -e "${BLUE}โน๏ธ $message${NC}"
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] โน๏ธ $message" >> "$DEPLOYMENT_LOG"
            ;;
    esac
}

# ุจุฏุงูุฉ ุงููุดุฑ
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ           ูุดุฑ ุงูุชุทุจูู ุนูู ุงูุฅูุชุงุฌ - Production Deployment      โ"
echo "โ                    $TIMESTAMP                      โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

print_status "info" "ุจุฏุก ุนูููุฉ ุงููุดุฑ..."

# ====== ุงููุฑุญูุฉ 1: ุงูุชุญุถูุฑ ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 1: ุงูุชุญุถูุฑ ูุงููุญุต ุงูุฃููู"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ูุญุต ุงููุชุทูุจุงุช
print_status "info" "ูุญุต ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ..."

if ! command -v node &> /dev/null; then
    print_status "error" "Node.js ุบูุฑ ูุซุจุช"
    exit 1
fi
print_status "ok" "Node.js ูุซุจุช: $(node -v)"

if ! command -v pnpm &> /dev/null; then
    print_status "error" "pnpm ุบูุฑ ูุซุจุช"
    exit 1
fi
print_status "ok" "pnpm ูุซุจุช: $(pnpm -v)"

if ! command -v git &> /dev/null; then
    print_status "error" "Git ุบูุฑ ูุซุจุช"
    exit 1
fi
print_status "ok" "Git ูุซุจุช: $(git -v)"

# ูุญุต ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
print_status "info" "ูุญุต ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช..."
if pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
    print_status "ok" "ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุงุญุฉ"
else
    print_status "warning" "ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฏ ูุง ุชููู ูุชุงุญุฉ"
fi

echo ""

# ====== ุงููุฑุญูุฉ 2: ุณุญุจ ุฃุญุฏุซ ุงูููุฏ ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 2: ุณุญุจ ุฃุญุฏุซ ุงูููุฏ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

cd "$APP_PATH"

print_status "info" "ุณุญุจ ุฃุญุฏุซ ุงูุชุญุฏูุซุงุช ูู Git..."
if git pull origin main; then
    print_status "ok" "ุชู ุณุญุจ ุฃุญุฏุซ ุงูููุฏ ุจูุฌุงุญ"
else
    print_status "error" "ูุดู ุณุญุจ ุงูููุฏ"
    exit 1
fi

echo ""

# ====== ุงููุฑุญูุฉ 3: ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 3: ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

print_status "info" "ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช (ูุฏ ูุณุชุบุฑู ุจุนุถ ุงูููุช)..."
if pnpm install --prod; then
    print_status "ok" "ุชู ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุจูุฌุงุญ"
else
    print_status "error" "ูุดู ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช"
    exit 1
fi

echo ""

# ====== ุงููุฑุญูุฉ 4: ุจูุงุก ุงูุชุทุจูู ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 4: ุจูุงุก ุงูุชุทุจูู"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

print_status "info" "ุจูุงุก ุงูุชุทุจูู..."
if pnpm build; then
    BUILD_SIZE=$(du -sh dist/ | cut -f1)
    print_status "ok" "ุชู ุจูุงุก ุงูุชุทุจูู ุจูุฌุงุญ (ุงูุญุฌู: $BUILD_SIZE)"
else
    print_status "error" "ูุดู ุจูุงุก ุงูุชุทุจูู"
    exit 1
fi

echo ""

# ====== ุงููุฑุญูุฉ 5: ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 5: ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

print_status "info" "ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช (ูุฏ ูุณุชุบุฑู ุจุนุถ ุงูููุช)..."
if pnpm test 2>&1 | tee -a "$DEPLOYMENT_LOG"; then
    print_status "ok" "ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช"
else
    print_status "warning" "ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุฏ ุชููู ูุงุดูุฉ"
fi

echo ""

# ====== ุงููุฑุญูุฉ 6: ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 6: ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

print_status "info" "ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
mkdir -p "$BACKUP_DIR"
BACKUP_FILE="$BACKUP_DIR/db_pre_deployment_$(date +%Y%m%d_%H%M%S).sql.gz"

if pg_dump -U postgres jordan_customs_prod 2>/dev/null | gzip > "$BACKUP_FILE"; then
    BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    print_status "ok" "ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุจูุฌุงุญ (ุงูุญุฌู: $BACKUP_SIZE)"
else
    print_status "warning" "ูุดู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ"
fi

echo ""

# ====== ุงููุฑุญูุฉ 7: ุชุทุจูู ุงููุฌุฑุงุช ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 7: ุชุทุจูู ุงููุฌุฑุงุช"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

print_status "info" "ุชุทุจูู ูุฌุฑุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
if pnpm db:push; then
    print_status "ok" "ุชู ุชุทุจูู ุงููุฌุฑุงุช ุจูุฌุงุญ"
else
    print_status "warning" "ูุฏ ูุง ุชููู ููุงู ูุฌุฑุงุช ุฌุฏูุฏุฉ"
fi

echo ""

# ====== ุงููุฑุญูุฉ 8: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 8: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

print_status "info" "ุฅููุงู ุงูุฎุฏูุงุช ุงูุญุงููุฉ..."
if systemctl stop jordan-customs 2>/dev/null; then
    print_status "ok" "ุชู ุฅููุงู ุงูุฎุฏูุฉ ุจูุฌุงุญ"
else
    print_status "warning" "ุงูุฎุฏูุฉ ูุฏ ูุง ุชููู ููุฏ ุงูุชุดุบูู"
fi

print_status "info" "ุจุฏุก ุงูุฎุฏูุงุช ุงูุฌุฏูุฏุฉ..."
if systemctl start jordan-customs; then
    print_status "ok" "ุชู ุจุฏุก ุงูุฎุฏูุฉ ุจูุฌุงุญ"
else
    print_status "error" "ูุดู ุจุฏุก ุงูุฎุฏูุฉ"
    exit 1
fi

# ุงูุชุธุฑ ููููุงู ูุจุฏุก ุงูุฎุฏูุฉ
sleep 3

print_status "info" "ุฅุนุงุฏุฉ ุชุดุบูู Nginx..."
if systemctl restart nginx; then
    print_status "ok" "ุชู ุฅุนุงุฏุฉ ุชุดุบูู Nginx ุจูุฌุงุญ"
else
    print_status "error" "ูุดู ุฅุนุงุฏุฉ ุชุดุบูู Nginx"
    exit 1
fi

echo ""

# ====== ุงููุฑุญูุฉ 9: ุงูุชุญูู ูู ุงูุตุญุฉ ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 9: ุงูุชุญูู ูู ุตุญุฉ ุงููุดุฑ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

print_status "info" "ูุญุต ุตุญุฉ ุงูุชุทุจูู..."
sleep 2

# ูุญุต ุงูุงุชุตุงู
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN" 2>/dev/null || echo "000")
if [ "$HTTP_CODE" = "200" ]; then
    print_status "ok" "ุงูุชุทุจูู ูุณุชุฌูุจ ุจุดูู ุตุญูุญ (HTTP $HTTP_CODE)"
else
    print_status "warning" "ูุฏ ุชููู ููุงู ูุดููุฉ ูู ุงูุงุชุตุงู (HTTP $HTTP_CODE)"
fi

# ูุญุต API
API_STATUS=$(curl -s "https://$DOMAIN/api/health" 2>/dev/null | jq -r '.status' 2>/dev/null || echo "unknown")
if [ "$API_STATUS" = "ok" ]; then
    print_status "ok" "API ูุนูู ุจุดูู ุตุญูุญ"
else
    print_status "warning" "ุญุงูุฉ API: $API_STATUS"
fi

# ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช
DB_TABLES=$(psql -U postgres -d jordan_customs_prod -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema='public';" 2>/dev/null || echo "0")
print_status "info" "ุนุฏุฏ ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: $DB_TABLES"

echo ""

# ====== ุงููุฑุญูุฉ 10: ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ ======
echo ""
print_status "info" "ุงููุฑุญูุฉ 10: ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ูุนูููุงุช ุงูุฎุงุฏู
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
MEM_USAGE=$(free | grep Mem | awk '{print ($3/$2) * 100}')
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')

print_status "info" "ุงุณุชุฎุฏุงู ุงูููุงุฑุฏ:"
echo "  โข CPU: ${CPU_USAGE}%"
echo "  โข ุงูุฐุงูุฑุฉ: ${MEM_USAGE}%"
echo "  โข ุงููุฑุต: ${DISK_USAGE}%"

# ูุนูููุงุช ุงูุชุทุจูู
print_status "info" "ูุนูููุงุช ุงูุชุทุจูู:"
echo "  โข ุงููุทุงู: $DOMAIN"
echo "  โข ุงููุณุงุฑ: $APP_PATH"
echo "  โข ุงูุฅุตุฏุงุฑ: $(git rev-parse --short HEAD)"
echo "  โข ุงููุฑุน: $(git rev-parse --abbrev-ref HEAD)"

echo ""

# ููุงูุฉ ุงููุดุฑ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                  โ ุงูุชูู ุงููุดุฑ ุจูุฌุงุญ                         โ"
echo "โ              Application deployed successfully!               โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

print_status "ok" "ุชู ูุดุฑ ุงูุชุทุจูู ุนูู ุงูุฅูุชุงุฌ ุจูุฌุงุญ"
print_status "info" "ุณุฌู ุงููุดุฑ: $DEPLOYMENT_LOG"

echo ""
echo "๐ ููุฎุต ุงููุดุฑ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ุชู ุณุญุจ ุฃุญุฏุซ ุงูููุฏ"
echo "โ ุชู ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช"
echo "โ ุชู ุจูุงุก ุงูุชุทุจูู"
echo "โ ุชู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช"
echo "โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ"
echo "โ ุชู ุชุทุจูู ุงููุฌุฑุงุช"
echo "โ ุชู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช"
echo "โ ุชู ุงูุชุญูู ูู ุงูุตุญุฉ"
echo ""
echo "๐ ุงููุทุงู: https://$DOMAIN"
echo "๐ ุงููุณุงุฑ: $APP_PATH"
echo "๐ ุงูุชุงุฑูุฎ: $TIMESTAMP"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

exit 0
